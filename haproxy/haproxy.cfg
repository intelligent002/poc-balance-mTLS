global
  log stdout format raw local0
  tune.ssl.default-dh-param 2048
  ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12
  ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12

defaults
  mode http
  option dontlognull
  option http-server-close
  option log-health-checks
  timeout connect 5s
  timeout client 60s
  timeout server 60s

  unique-id-format %{+X}o%ci-%cp-%fi-%fp-%Ts
  unique-id-header X-Request-ID

  log-format "{\"ts\":\"%t\",\"uid\":\"%ID\",\"client_ip\":\"%ci\",\"client_port\":\"%cp\",\"frontend\":\"%ft\",\"backend\":\"%b\",\"server\":\"%s\",\"upstream_addr\":\"%si:%sp\",\"http_request\":\"%r\",\"status\":%ST,\"bytes\":%B,\"tls\":{\"enabled\":%[ssl_fc],\"protocol\":\"%[ssl_fc_protocol]\",\"frontend_sni\":\"%[ssl_fc_sni]\",\"client_cn\":\"%[ssl_c_s_dn(cn)]\",\"client_verify\":%[ssl_c_verify]},\"timings\":{\"total_ms\":%Tt,\"connect_ms\":%Tc,\"handshake_ms\":%Th,\"queue_ms\":%Tw,\"response_ms\":%Tr},\"retries\":%rc,\"srv_queue\":%sq,\"backend_queue\":%bq,\"upstream\":\"%[srv_name]\"}"

################################################################
# HEALTH ENDPOINT
################################################################
frontend health
  bind 0.0.0.0:9301
  monitor-uri /health

################################################################
# PROMETHEUS METRICS
################################################################
frontend metrics
  bind 0.0.0.0:9302
  http-request use-service prometheus-exporter

################################################################
# SINGLE-NODE BACKENDS (Ansible-templated for dynamic nodes)
################################################################
backend be-connect-node-01
  http-request set-header Host node-01.intel.r7g.org
  server node-01 node-01.intel.r7g.org:8401 ssl crt /data/cluster/certificates/users/admin/admin.pem ca-file /data/cluster/certificates/CA/ca.crt verify required sni str(node-01.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2

  option httpchk
  http-check connect ssl
  http-check send meth GET uri /health ver HTTP/1.1 hdr Host node-01.intel.r7g.org
  http-check expect status 200

backend be-connect-node-02
  http-request set-header Host node-02.intel.r7g.org
  server node-02 node-02.intel.r7g.org:8402 ssl crt /data/cluster/certificates/users/admin/admin.pem ca-file /data/cluster/certificates/CA/ca.crt verify required sni str(node-02.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2

  option httpchk
  http-check connect ssl
  http-check send meth GET uri /health ver HTTP/1.1 hdr Host node-02.intel.r7g.org
  http-check expect status 200

backend be-connect-node-03
  http-request set-header Host node-03.intel.r7g.org
  server node-03 node-03.intel.r7g.org:8403 ssl crt /data/cluster/certificates/users/admin/admin.pem ca-file /data/cluster/certificates/CA/ca.crt verify required sni str(node-03.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2

  option httpchk
  http-check connect ssl
  http-check send meth GET uri /health ver HTTP/1.1 hdr Host node-03.intel.r7g.org
  http-check expect status 200

################################################################
# INTERNAL FRONTENDS (Plain HTTP loopback, dynamic port scheme)
################################################################
frontend fe-connect-node-01
  bind 127.0.0.1:8301
  default_backend be-connect-node-01

frontend fe-connect-node-02
  bind 127.0.0.1:8302
  default_backend be-connect-node-02

frontend fe-connect-node-03
  bind 127.0.0.1:8303
  default_backend be-connect-node-03

################################################################
# CLUSTER BACKEND
################################################################
backend be-connect-group
  balance roundrobin

  server node-01 127.0.0.1:8301 track be-connect-node-01/node-01
  server node-02 127.0.0.1:8302 track be-connect-node-02/node-02
  server node-03 127.0.0.1:8303 track be-connect-node-03/node-03

################################################################
# FRONTEND (mTLS) â€” KAFKA CONNECT LB ENTRYPOINT
################################################################
frontend fe-connect-group
  log global
  bind 0.0.0.0:8300 ssl crt /data/cluster/certificates/nodes/node-00.intel.r7g.org/node-00.intel.r7g.org.pem ca-file /data/cluster/certificates/CA/ca.crt verify optional alpn h2,http/1.1

  http-request deny if !{ ssl_c_verify 0 }
  http-request set-header X-Forwarded-For %[src]
  http-request set-header X-Forwarded-Proto https if { ssl_fc }
  http-response set-header X-Upstream-Node %[srv_name].intel.r7g.org
  default_backend be-connect-group
